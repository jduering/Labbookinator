<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Labbook Automation ¬∑ Experiment Tracker</title>

  <style>
    :root {
      /* Palette derived from the Labbookinator turtle image */
      --turtle-shell: #3a4745;      /* dark teal-grey (outlines/text) */
      --turtle-skin: #899186;       /* desaturated green-grey */
      --turtle-highlight: #d68c45;  /* warm shell orange */
      --turtle-sand: #fdf6ea;       /* cream background */
      --turtle-brown: #b56a3b;      /* deeper shell brown */
      --card-bg: rgba(255, 252, 245, 0.98);
      --text-main: #3a4745;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1.5rem;
      background:
        radial-gradient(circle at top left, rgba(137, 145, 134, 0.28), transparent 55%),
        radial-gradient(circle at bottom right, rgba(214, 140, 69, 0.24), var(--turtle-sand));
      background-color: var(--turtle-sand);
    }

    /* Password protection: hide body until unlocked */
    body.protected {
      display: none !important;
    }

    .page {
      width: 100%;
      max-width: 1120px;
      background: linear-gradient(
        145deg,
        rgba(254, 252, 238, 0.98),
        rgba(253, 246, 234, 0.96)
      );
      border-radius: 24px;
      padding: 1.5rem 2.25rem 2rem;
      box-shadow:
        0 22px 55px rgba(58, 71, 69, 0.4),
        0 0 0 1px rgba(191, 191, 172, 0.7);
      backdrop-filter: blur(14px);
    }

    /* Hero header image */
    .hero {
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 1.25rem;
      box-shadow:
        0 18px 40px rgba(58, 71, 69, 0.45),
        0 0 0 1px rgba(58, 71, 69, 0.5);
      background: var(--turtle-sand);
    }

    .hero img {
      display: block;
      width: 100%;
      height: auto;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-end;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid rgba(58, 71, 69, 0.25);
      padding-bottom: 0.75rem;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.8rem, 3vw, 2.4rem);
      color: var(--turtle-shell);
      letter-spacing: 0.03em;
    }

    header p {
      margin: 0;
      font-size: 0.95rem;
      max-width: 380px;
      color: rgba(58, 71, 69, 0.9);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.25rem 0.65rem;
      border-radius: 999px;
      background: rgba(137, 145, 134, 0.15);
      color: var(--turtle-shell);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: 1px solid rgba(58, 71, 69, 0.5);
    }

    .badge::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--turtle-highlight);
      box-shadow: 0 0 10px rgba(214, 140, 69, 0.6);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 1.25rem;
      align-items: start; /* let tiles have their own height */
    }

    /* Generic card */
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.1rem 1.4rem;
      box-shadow:
        0 8px 20px rgba(58, 71, 69, 0.18),
        0 0 0 1px rgba(191, 191, 172, 0.9);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at top left, rgba(137, 145, 134, 0.2), transparent 55%),
        radial-gradient(circle at bottom right, rgba(214, 140, 69, 0.25), transparent 50%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .counter-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: rgba(58, 71, 69, 0.7);
      margin-bottom: 0.5rem;
    }

    .experiment-number {
      font-size: clamp(3.2rem, 5.4vw, 4.6rem);
      font-weight: 800;
      letter-spacing: 0.16em;
      color: var(--turtle-shell);
      text-shadow:
        0 5px 14px rgba(58, 71, 69, 0.6),
        0 0 1px rgba(58, 71, 69, 0.9);
      margin-bottom: 0.4rem;
      padding-bottom: 0.3rem;
      border-bottom: 1px dashed rgba(191, 191, 172, 0.9);
      text-align: center;
    }

    .counter-subtext {
      font-size: 0.85rem;
      color: rgba(58, 71, 69, 0.9);
      margin-bottom: 0.7rem;
      text-align: center;
    }

    .meta-row {
      display: flex;
      gap: 0.5rem;
      justify-content: space-between;
      flex-wrap: wrap;
      font-size: 0.78rem;
      color: rgba(58, 71, 69, 0.8);
    }

    .meta-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(254, 246, 234, 0.95);
      border: 1px solid rgba(137, 145, 134, 0.9);
      font-size: 0.75rem;
      white-space: nowrap;
    }

    .meta-pill span.icon {
      font-size: 0.9rem;
    }

    /* Google Form section */
    .form-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 1.1rem 1.4rem;
      box-shadow:
        0 8px 20px rgba(58, 71, 69, 0.18),
        0 0 0 1px rgba(191, 191, 172, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }

    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 0.75rem;
    }

    .form-header h2 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--turtle-shell);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .form-description {
      font-size: 0.88rem;
      color: rgba(58, 71, 69, 0.85);
      line-height: 1.45;
    }

    .form-placeholder {
      flex: 1;
      margin-top: 0.35rem;
      border-radius: 16px;
      border: 2px solid rgba(191, 191, 172, 0.9);
      background: rgba(254, 252, 238, 0.98);
      padding: 0.5rem;
      max-height: 560px;      /* cap tile height */
      overflow: auto;         /* scroll inside if needed */
    }

    .form-placeholder iframe {
      width: 100%;
      height: 520px;          /* shorter form */
      border: 0;
    }

    /* PROTOCOL CARD */
    .protocol-card {
      margin-top: 1.5rem;
    }

    .protocol-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .protocol-header h2 {
      margin: 0;
      font-size: 1.05rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--turtle-shell);
    }

    .protocol-hint {
      font-size: 0.85rem;
      color: rgba(58, 71, 69, 0.8);
      margin: 0 0 0.6rem 0;
    }

    .protocol-body {
      margin: 0;
      white-space: pre-wrap;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      font-size: 0.9rem;
      line-height: 1.45;
      background: #f7f4eb;
      padding: 0.9rem 1rem;
      border-radius: 12px;
      border: 1px solid rgba(191, 191, 172, 0.9);
    }

    /* Protocol search UI */
    .protocol-search {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin: 0.2rem 0 0.8rem;
      font-size: 0.85rem;
    }

    .protocol-search input {
      border-radius: 999px;
      border: 1px solid rgba(137, 145, 134, 0.9);
      padding: 0.2rem 0.6rem;
      width: 4.5rem;
      font-size: 0.85rem;
      background: rgba(254, 252, 238, 0.98);
    }

    .protocol-search button {
      border-radius: 999px;
      border: none;
      padding: 0.25rem 0.8rem;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      background: var(--turtle-shell);
      color: #fffdf7;
    }

    .protocol-search button:hover {
      opacity: 0.9;
    }

    .protocol-search input.invalid {
      border-color: #b56a3b;
      background: rgba(181, 106, 59, 0.08);
    }

    code {
      font-family: "JetBrains Mono", Menlo, Consolas, monospace;
      font-size: 0.8rem;
      background: rgba(137, 145, 134, 0.1);
      padding: 0.1rem 0.35rem;
      border-radius: 6px;
    }

    @media (max-width: 800px) {
      .page {
        padding: 1.2rem 1.1rem 1.6rem;
      }

      .layout {
        grid-template-columns: minmax(0, 1fr);
      }

      .experiment-number {
        letter-spacing: 0.14em;
      }

      .protocol-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 520px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .form-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body class="protected">
  <div class="page">
    <div class="hero">
      <img
        src="https://github.com/jduering/Labbookinator/blob/main/Add%20a%20heading.png?raw=true"
        alt="Labbookinator ‚Äì Labbook Automation Header"
      />
    </div>

    <header>
      <div>
        <div class="badge">Labbook Automation UI</div>
        <h1>Experiment Registry</h1>
      </div>
      <p>
        Central place to see the latest experiment number and submit new runs
        via your automated labbook workflow.
      </p>
    </header>

    <main class="layout">
      <!-- BIG COUNTER -->
      <section class="card" aria-label="Latest experiment number">
        <div class="card-inner">
          <div class="counter-label">Current last experiment</div>
          <!-- Fallback value, will be replaced by JS -->
          <div class="experiment-number" id="experiment-number">
            042
          </div>
          <p class="counter-subtext">
            This is the latest assigned experiment ID in your automated labbook.
          </p>

          <div class="meta-row">
            <div class="meta-pill">
              <span class="icon">üê¢</span>
              <span>Safe incremental numbering</span>
            </div>
            <div class="meta-pill">
              <span class="icon">üß™</span>
              <span>Ready for next experiment</span>
            </div>
          </div>
        </div>
      </section>

      <!-- GOOGLE FORM AREA -->
      <section class="form-card">
        <div class="form-header">
          <h2>New Experiment Submission</h2>
        </div>
        <p class="form-description">
          Submit raw notes or parameters for each new experiment. Your Make.com /
          labbook automation can then turn these into clean protocols and log all reagents.
        </p>

        <div class="form-placeholder" id="google-form-container">
          <iframe
            src="https://docs.google.com/forms/d/e/1FAIpQLSc7gxfI-xwMNXVhxefOE-ri2oCp6oJWF8RV2GK_YMWdj1MpeA/viewform?embedded=true"
            width="100%"
            frameborder="0"
            marginheight="0"
            marginwidth="0"
          >
            Loading‚Ä¶
          </iframe>
        </div>
      </section>
    </main>

    <!-- LAST EXPERIMENT PROTOCOL (from Google Sheet) -->
    <section class="card protocol-card" aria-label="Last experiment protocol">
      <div class="card-inner">
        <div class="protocol-header">
          <h2>Last Experiment Protocol</h2>
          <div class="meta-pill">
            <span class="icon">üìÑ</span>
            <span>Experiment <span id="last-experiment-number">‚Äì</span></span>
          </div>
        </div>
        <p class="protocol-hint">
          Loaded live from your experiment registry Google Sheet.
        </p>
        <div class="protocol-search">
          <span>Jump to Exp Nr.:</span>
          <input
            id="exp-search-input"
            type="number"
            min="1"
            step="1"
            placeholder="e.g. 12"
          />
          <button id="exp-search-button" type="button">Load</button>
        </div>
        <pre id="last-experiment-protocol" class="protocol-body">Loading protocol‚Ä¶</pre>
      </div>
    </section>
  </div>

  <!-- Simple front-end password protection -->
  <script>
    (function () {
      var PASSWORD = "HotTigers@zh";
      var MAX_TRIES = 3;
      var authorized = false;

      for (var i = 0; i < MAX_TRIES; i++) {
        var input = prompt("Enter password to access this page:");
        if (input === null) break; // user cancelled
        if (input === PASSWORD) {
          authorized = true;
          break;
        }
      }

      if (authorized) {
        // show the page
        document.body.classList.remove("protected");
      } else {
        // replace content with an "access denied" message
        document.body.innerHTML =
          '<div style="font-family: system-ui, -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, sans-serif; min-height:100vh; display:flex; align-items:center; justify-content:center; background:#fdf6ea; color:#3a4745; padding:2rem; box-sizing:border-box;">' +
            '<div style="max-width:480px; text-align:center;">' +
              '<h1 style="margin-bottom:0.75rem; font-size:1.8rem;">Access denied</h1>' +
              '<p style="margin:0; font-size:0.95rem;">Incorrect password. Reload the page to try again.</p>' +
            "</div>" +
          "</div>";
        document.body.classList.remove("protected");
      }
    })();
  </script>

  <!-- Botpress chatbot (new version) -->
  <script src="https://cdn.botpress.cloud/webchat/v3.4/inject.js"></script>
  <script src="https://files.bpcontent.cloud/2025/11/20/13/20251120135545-5ASOW9FL.js" defer></script>

  <script>
    // CSV parser that respects quotes, commas, and multi-line fields
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cell = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];

        if (c === '"') {
          if (inQuotes && text[i + 1] === '"') {
            // Escaped quote ("")
            cell += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (c === ',' && !inQuotes) {
          row.push(cell);
          cell = '';
        } else if ((c === '\n' || c === '\r') && !inQuotes) {
          // End of row
          if (c === '\r' && text[i + 1] === '\n') {
            i++;
          }
          row.push(cell);
          rows.push(row);
          row = [];
          cell = '';
        } else {
          cell += c;
        }
      }

      if (cell.length > 0 || row.length > 0) {
        row.push(cell);
        rows.push(row);
      }

      return rows;
    }

    function normalizeHeaderCell(h) {
      return h
        .replace(/\uFEFF/g, '')        // remove BOM if present
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '');    // strip spaces, dots, etc.
    }

    let experimentRows = [];

    function displayExperiment(exp) {
      if (!exp) return;

      const bigCounterEl   = document.getElementById('experiment-number');
      const smallCounterEl = document.getElementById('last-experiment-number');
      const protoEl        = document.getElementById('last-experiment-protocol');

      // Normalize line breaks
      let protocol = exp.protocol || "";
      protocol = protocol
        .replace(/\r\n/g, '\n')
        .replace(/\r/g, '\n')
        .replace(/\\n/g, '\n')
        .replace(/&#10;|&#13;/g, '\n');

      const padded = String(exp.expNr).padStart(3, '0');

      if (bigCounterEl)   bigCounterEl.textContent   = padded;
      if (smallCounterEl) smallCounterEl.textContent = padded;
      if (protoEl)        protoEl.textContent        = protocol.trim() || "Protocol column is empty for this experiment.";
    }

    async function loadExperimentData() {
      const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTt5IuGNQY_nW-xFZguKwJzUFQgudj0UGIiiYU--tKsn-g3mv9qPDEQVIy4q3YtErFUmmxBd_BHrYa7/pub?gid=0&single=true&output=csv";

      const bigCounterEl   = document.getElementById('experiment-number');
      const smallCounterEl = document.getElementById('last-experiment-number');
      const protoEl        = document.getElementById('last-experiment-protocol');
      const searchInput    = document.getElementById('exp-search-input');
      const searchButton   = document.getElementById('exp-search-button');

      try {
        const res = await fetch(SHEET_URL);
        if (!res.ok) throw new Error("Network response was not ok: " + res.status);
        const text = await res.text();

        const rows = parseCSV(text);
        if (!rows.length) throw new Error("Sheet appears to be empty");

        const rawHeader = rows[0];
        const header = rawHeader.map(normalizeHeaderCell);

        // "Date,Exp Nr.,Protocol" -> "date","expnr","protocol"
        const dateIdx     = header.indexOf('date');
        const exprIdx     = header.indexOf('expnr');
        const protocolIdx = header.indexOf('protocol');

        if (exprIdx === -1 || protocolIdx === -1) {
          throw new Error("Could not find 'Exp Nr.' or 'Protocol' columns in header");
        }

        experimentRows = [];

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.length <= exprIdx) continue;

          const rawVal = (row[exprIdx] || '').toString().trim();
          const num = parseFloat(rawVal);
          if (Number.isNaN(num)) continue;

          const protocol = row[protocolIdx] || "";
          const date = dateIdx !== -1 ? (row[dateIdx] || "") : "";

          experimentRows.push({
            expNr: num,
            protocol,
            date
          });
        }

        if (!experimentRows.length) {
          throw new Error("No valid numeric values found in 'Exp Nr.' column");
        }

        // Sort by Exp Nr. and show the last one as default
        experimentRows.sort((a, b) => a.expNr - b.expNr);
        const last = experimentRows[experimentRows.length - 1];
        displayExperiment(last);

        // Hook up search
        if (searchInput && searchButton) {
          const doSearch = () => {
            const val = searchInput.value.trim();
            if (!val) {
              searchInput.classList.add('invalid');
              return;
            }
            const num = parseFloat(val);
            if (Number.isNaN(num)) {
              searchInput.classList.add('invalid');
              return;
            }

            const match = experimentRows.find(r => r.expNr === num);
            if (match) {
              searchInput.classList.remove('invalid');
              displayExperiment(match);
            } else {
              searchInput.classList.add('invalid');
              if (smallCounterEl) smallCounterEl.textContent = "‚Äì";
              if (protoEl) protoEl.textContent = `No experiment with Exp Nr. ${val} found.`;
            }
          };

          searchButton.addEventListener('click', doSearch);
          searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              doSearch();
            }
          });
        }
      } catch (err) {
        console.error("Error loading experiment data:", err);
        if (bigCounterEl)   bigCounterEl.textContent   = "‚Äì";
        if (smallCounterEl) smallCounterEl.textContent = "‚Äì";
        if (protoEl)        protoEl.textContent        = "Could not load protocol from the Google Sheet.";
      }
    }

    document.addEventListener('DOMContentLoaded', loadExperimentData);
  </script>
</body>
</html>
